<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µæ± æ—©æœŸç”Ÿå‘½é¢„æµ‹2</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* å…¨å±€é‡ç½® - ç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½å¯ä»¥ç‚¹å‡» */
        * {
            pointer-events: auto !important;
        }
        
        /* å¼ºåˆ¶å¯ç”¨ç‚¹å‡»äº‹ä»¶ */
        .upload-area, .upload-area * {
            pointer-events: auto !important;
        }
        
        /* ç¡®ä¿å…ƒç´ å¯ä»¥æ¥æ”¶ç‚¹å‡»äº‹ä»¶ */
        #uploadArea {
            position: relative !important;
            z-index: 1000 !important;
            pointer-events: auto !important;
        }
        

        
        /* ç½®ä¿¡åº¦é¢œè‰²æ ·å¼ */
        .confidence-high {
            color: #10b981;
        }
        
        .confidence-medium {
            color: #f59e0b;
        }
        
        .confidence-low {
            color: #ef4444;
        }
        
        /* å†å²è®°å½•æ ·å¼å¢å¼º */
        .history-result {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .avg-cycle-life {
            font-size: 0.8rem;
            color: #1a1a1a;
            font-weight: 500;
        }
        
        /* é¢„æµ‹ç»“æœæ‘˜è¦æ ·å¼ */
        .prediction-summary {
            margin-top: 2.5rem;
        }
        
        .summary-header h4 {
            margin: 0 0 1rem 0;
            color: #1e293b;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .summary-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .summary-item {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f5f9;
            border: none !important;
            outline: none !important;
        }
        
        .summary-item * {
            border: none !important;
            outline: none !important;
        }
        
        .summary-label {
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .summary-value {
            color: #1e293b;
            font-weight: 600;
            font-size: 1rem;
        }
        
        /* ç®€çº¦ç»“æœè¡¨æ ¼æ ·å¼ */
        .results-table table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            border: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .results-table th {
            background: #f8fafc;
            color: #374151;
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            border: none;
            letter-spacing: 0.025em;
        }
        
        .results-table td {
            padding: 10px 12px;
            border: none;
            color: #475569;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .results-table tr:nth-child(even) td {
            background: #fafbfc;
        }
        
        .results-table tr:hover td {
            background: #f8fafc;
            color: #1e293b;
        }
        

        
        /* å·²ä¸Šä¼ æ–‡ä»¶æ˜¾ç¤ºæ ·å¼ */
        .uploaded-file-display {
            margin: 1rem 0;
            padding: 1.5rem;
            background: #f0fdf4;
            border: 2px solid #bbf7d0;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .uploaded-file-display:hover {
            background: #ecfdf5;
            border-color: #86efac;
        }
        
        .uploaded-file-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .file-icon {
            flex-shrink: 0;
        }
        
        .file-details {
            flex: 1;
        }
        
        .file-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            transition: color 0.2s ease;
        }
        
        .file-name:hover {
            color: #059669 !important;
        }
        
        .file-stats {
            font-size: 0.9rem;
            color: #6b7280;
        }
        
        .file-actions {
            flex-shrink: 0;
        }
        
        .change-file-btn {
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            color: #374151;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .change-file-btn:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }
        
        /* æ•°æ®é¢„è§ˆå¼¹çª—æ ·å¼ */
        .data-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            position: relative;
            background: white;
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-width: 90vw;
            max-height: 90vh;
            width: 800px;
            overflow: hidden;
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #1f2937;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .close-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .data-info {
            margin-bottom: 1rem;
            padding: 0.5rem 0;
        }
        
        .data-info p {
            margin: 0.25rem 0;
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .data-table-container {
            overflow-x: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            display: flex;
            justify-content: center;
        }
        
        .data-preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .data-preview-table th {
            background: #374151;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-preview-table td {
            padding: 8px;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .data-preview-table tr:nth-child(even) td {
            background: #f3f4f6;
        }
        
        .data-preview-table tr:hover td {
            background: #e5e7eb;
        }
        
        .data-note {
            margin-top: 1rem;
            padding: 0.5rem;
            color: #9ca3af;
            font-size: 0.85rem;
            text-align: center;
            font-style: italic;
        }
        
        /* æ ·ä¾‹æ•°æ®é“¾æ¥æ ·å¼ */
        .sample-data-link {
            text-align: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }
        
        .sample-data-link a {
            color: #1a1a1a !important;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            padding: 8px 16px;
            border: 1px solid #1a1a1a;
            border-radius: 6px;
            background: rgba(86, 178, 106, 0.1);
            transition: all 0.3s ease;
        }
        
        .sample-data-link a:hover {
            background: #1a1a1a;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(86, 178, 106, 0.3);
        }
        
        /* æè¿°æ–‡å­—ä¸­çš„æ ·ä¾‹æ•°æ®é“¾æ¥æ ·å¼ */
        .module-description a {
            color: #1a1a1a !important;
            text-decoration: none;
            font-weight: 500;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .module-description a:hover {
            background: #1a1a1a;
            color: white !important;
            text-decoration: none;
        }

        /* æ ·ä¾‹æ•°æ®å¡ç‰‡æ ·å¼ */
        .sample-data-section {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .sample-data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .sample-data-header h6 {
            margin: 0;
            color: #1a1a1a;
            font-size: 1rem;
            font-weight: 600;
        }

        .sample-data-subtitle {
            color: #6b7280;
            font-size: 0.8rem;
        }

        .sample-data-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }

        .sample-data-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 1.5rem;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .sample-data-card:hover {
            border-color: #1a1a1a;
            box-shadow: 0 4px 12px rgba(86, 178, 106, 0.1);
        }

        .card-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .card-content {
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .card-desc {
            font-size: 0.85rem;
            color: #475569;
            margin-bottom: 0.75rem;
        }

        .card-stats {
            display: flex;
            gap: 0.75rem;
            font-size: 0.8rem;
            color: #6b7280;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .card-actions {
            display: flex;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .preview-btn, .use-btn {
            flex: 1;
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .preview-btn {
            background: #f3f4f6;
            color: #374151;
        }

        .preview-btn:hover {
            background: #e5e7eb;
            color: #1e293b;
        }

        .use-btn {
            background: #1a1a1a;
            color: white;
        }

        .use-btn:hover {
            background: #4f9a5a;
        }

        /* æ ·ä¾‹æ•°æ®é¢„è§ˆå¼¹çª—æ ·å¼ */
        .sample-data-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .sample-data-modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 90vw;
            max-height: 90vh;
            width: 800px;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .modal-body {
            padding: 2rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .data-table tr:hover {
            background: #f9fafb;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .modal-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .modal-btn-secondary:hover {
            background: #e5e7eb;
        }

        .modal-btn-primary {
            background: #1a1a1a;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #4f9a5a;
        }

        .data-info {
            display: flex;
            gap: 2rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .info-label {
            font-size: 0.8rem;
            color: #6b7280;
            font-weight: 500;
        }

        .info-value {
            font-size: 1rem;
            color: #1e293b;
            font-weight: 600;
        }


    </style>
</head>
<body>
    <header class="main-header">
        <div class="logo-container">
            <img src="logo.png" alt="SES Logo" class="logo-img">
        </div>
        <nav class="main-nav">
            <a href="map.html" class="nav-item">Map</a>
            <a href="chat.html" class="nav-item">Ask</a>
            <a href="#" class="nav-item">Search</a>
            <a href="#" class="nav-item">Filter</a>
            <a href="#" class="nav-item">Favorites</a>
            <div class="nav-item dropdown active">
                <a href="#" class="nav-item">Prediction</a>
                <div class="dropdown-menu">
                    <a href="battery-prediction.html" class="dropdown-item">
                        ç”µæ± æ€§èƒ½è¡¨å¾
                    </a>
                    <a href="prediction-tool.html" class="dropdown-item active">
                        ç”µæ± æ—©æœŸç”Ÿå‘½é¢„æµ‹å·¥å…· <span class="beta-badge">Beta</span>
                    </a>
                </div>
            </div>
        </nav>
        <div class="user-actions">
            <a href="about.html" class="nav-item" target="_blank" rel="noopener noreferrer">About â†—</a>
            <div class="user-avatar-container">
                <a href="#" class="action-icon user-avatar" id="userAvatar">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24px" height="24px">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                    </svg>
                </a>
            </div>
        </div>
    </header>



    <main class="prediction-container">
        <div class="prediction-content">
            <div class="page-header">
                <div class="battery-header">
                    <h3>ç”µæ± æ—©æœŸç”Ÿå‘½é¢„æµ‹2 <span class="beta-badge">Beta</span></h3>
                </div>
            </div>
            
            <div class="battery-divider"></div>
            
            <div class="battery-main-layout">
                <div class="battery-function-area">
                    <div class="modern-function-card">
                        <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
                        <div class="step-indicators">
                            <div class="step-item active">
                                <div class="step-icon">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M17 8L12 3L7 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M12 3V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div class="step-text">
                                    <div class="step-title">æ•°æ®ä¸Šä¼ </div>
                                </div>
                            </div>
                            <div class="step-connector"></div>
                            <div class="step-item">
                                <div class="step-icon">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div class="step-text">
                                    <div class="step-title">é¢„æµ‹åˆ†æ</div>
                                </div>
                            </div>
                            <div class="step-connector"></div>
                            <div class="step-item">
                                <div class="step-icon">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M3 3V21H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M9 9L12 6L15 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M12 6V18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div class="step-text">
                                    <div class="step-title">ç»“æœå±•ç¤º</div>
                                </div>
                            </div>
                        </div>

                        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
                        <div class="main-content-area">
                            <!-- æ•°æ®ä¸Šä¼ åŒºåŸŸ -->
                            <div class="upload-section" id="uploadSection">
                                <div class="upload-area" id="uploadArea">
                                    <div class="upload-content">
                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="#6B7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M17 8L12 3L7 8" stroke="#6B7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M12 3V15" stroke="#6B7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        <div class="upload-text">ç‚¹å‡»ä¸Šä¼ ç”µæ± æ•°æ®æ–‡ä»¶</div>
                                        <div class="upload-note">æ”¯æŒåŒ…å«å¾ªç¯æ¬¡æ•°ã€å®¹é‡ã€ç”µå‹ã€æ¸©åº¦ç­‰å‚æ•°çš„CSVã€Excel æ–‡ä»¶,æœ€å¤§100MB</div>
                                        <button class="select-file-btn" onclick="document.getElementById('fileInput').click()">é€‰æ‹©æ–‡ä»¶</button>
                                        
                                        <!-- æ ·ä¾‹æ•°æ®å±•ç¤ºåŒºåŸŸ -->
                                        <div class="sample-data-section">
                                            <div class="sample-data-header">
                                                <h6><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; margin-right: 6px; vertical-align: middle;">
                                                    <path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.89 22 5.99 22H18C19.1 22 20 21.1 20 20V8L14 2Z" stroke="#1a1a1a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                    <path d="M14 2V8H20" stroke="#1a1a1a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>æ ·ä¾‹æ•°æ®</h6>
                                                <span class="sample-data-subtitle">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…æˆ–ç›´æ¥ä½¿ç”¨</span>
                                            </div>
                                            <div class="sample-data-cards">
                                                <div class="sample-data-card" onclick="previewSampleData('battery')">
                                                    <div class="card-icon">ğŸ”‹</div>
                                                    <div class="card-content">
                                                        <div class="card-title">ç”µæ± å¾ªç¯æ•°æ®</div>
                                                        <div class="card-desc">åŒ…å«15ä¸ªç”µæ± æ ·æœ¬çš„å¾ªç¯æµ‹è¯•æ•°æ®</div>
                                                        <div class="card-stats">
                                                            <span class="stat-item">ğŸ“Š 15ä¸ªæ ·æœ¬</span>
                                                            <span class="stat-item">ğŸ”„ 70ä¸ªå¾ªç¯</span>
                                                        </div>
                                                    </div>
                                                    <div class="card-actions">
                                                        <button class="preview-btn" onclick="event.stopPropagation(); previewSampleData('battery')">é¢„è§ˆ</button>
                                                        <button class="use-btn" onclick="event.stopPropagation(); useSampleData('battery')">ä½¿ç”¨</button>
                                                    </div>
                                                </div>
                                                
                                                <div class="sample-data-card" onclick="previewSampleData('performance')">
                                                    <div class="card-icon">ğŸ“ˆ</div>
                                                    <div class="card-content">
                                                        <div class="card-title">æ€§èƒ½è¡¨å¾æ•°æ®</div>
                                                        <div class="card-desc">ç”µæ± å®¹é‡ã€ç”µå‹ã€æ¸©åº¦ç­‰æ€§èƒ½å‚æ•°</div>
                                                        <div class="card-stats">
                                                            <span class="stat-item">ğŸ“Š 8ä¸ªæ ·æœ¬</span>
                                                            <span class="stat-item">âš¡ å¤šå‚æ•°</span>
                                                        </div>
                                                    </div>
                                                    <div class="card-actions">
                                                        <button class="preview-btn" onclick="event.stopPropagation(); previewSampleData('performance')">é¢„è§ˆ</button>
                                                        <button class="use-btn" onclick="event.stopPropagation(); useSampleData('performance')">ä½¿ç”¨</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                            </div>

                            <!-- å·²ä¸Šä¼ æ•°æ®å±•ç¤ºåŒºåŸŸ -->
                            <div class="uploaded-data-section" id="uploadedDataSection" style="display: none;">
                                <div class="uploaded-file-display" id="uploadedFileDisplay">
                                    <!-- åŠ¨æ€ç”Ÿæˆçš„æ–‡ä»¶ä¿¡æ¯ -->
                                </div>
                                <button class="start-prediction-btn" id="startPredictionBtn" onclick="startPrediction()" style="display: none;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
                                    </svg>
                                    å¼€å§‹é¢„æµ‹
                                </button>
                            </div>

                            <!-- é¢„æµ‹è¿›åº¦åŒºåŸŸ -->
                            <div class="prediction-progress-section" id="predictionProgressSection" style="display: none;">
                                <div class="progress-header">
                                    <div class="progress-icon">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2"/>
                                            <path d="M12 3C16.9706 3 21 7.02944 21 12" stroke="#1a1a1a" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                    </div>
                                    <div class="progress-text">
                                        <div class="progress-title">AIé¢„æµ‹åˆ†æä¸­</div>
                                        <div class="progress-description">æ­£åœ¨åˆ†æç”µæ± æ•°æ®ï¼Œè¯·ç¨å€™...</div>
                                    </div>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill"></div>
                                </div>
                                <div class="progress-status" id="progressStatus">æ­£åœ¨åˆå§‹åŒ–æ¨¡å‹...</div>
                            </div>

                            <!-- é¢„æµ‹ç»“æœåŒºåŸŸ -->
                            <div class="prediction-results-section" id="predictionResultsSection" style="display: none;">
                                <!-- é¢„æµ‹ç»“æœæ‘˜è¦ -->
                                <div class="prediction-summary" id="predictionSummary">
                                    <div class="summary-header">
                                        <h4>é¢„æµ‹æ‘˜è¦</h4>
                                    </div>
                                    <div class="summary-content">
                                        <div class="summary-item">
                                            <span class="summary-label">ç”µèŠ¯æ•°é‡:</span>
                                            <span class="summary-value" id="totalSamples">-</span>
                                        </div>
                                        <div class="summary-item">
                                            <span class="summary-label">å¹³å‡å¾ªç¯å¯¿å‘½:</span>
                                            <span class="summary-value" id="avgCycleLife">-</span>
                                        </div>
                                        <div class="summary-item">
                                            <span class="summary-label">é¢„æµ‹æ—¶é—´:</span>
                                            <span class="summary-value" id="predictionTime">-</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- é¢„æµ‹ç»“æœå±•ç¤ºåŒºåŸŸ -->
                                <div class="results-preview" id="resultsPreview">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="battery-history-area">
                    <div class="history-header">
                        <h3>é¢„æµ‹è®°å½•</h3>
                        <button class="clear-history-btn" onclick="clearHistory()" title="æ¸…ç©ºè®°å½•">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 6H5H21M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                    <div class="history-list" id="historyList">
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- æ ·ä¾‹æ•°æ®é¢„è§ˆå¼¹çª— -->
    <div class="sample-data-modal" id="sampleDataModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">æ ·ä¾‹æ•°æ®é¢„è§ˆ</h3>
                <button class="modal-close" onclick="closeSampleDataModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="data-info" id="dataInfo">
                    <!-- æ•°æ®ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="data-table-container">
                    <table class="data-table" id="dataTable">
                        <!-- æ•°æ®è¡¨æ ¼å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeSampleDataModal()">å…³é—­</button>
                <button class="modal-btn modal-btn-primary" onclick="useSampleDataFromModal()">ä½¿ç”¨æ­¤æ•°æ®</button>
            </div>
        </div>
    </div>

    <script>
        console.log('è„šæœ¬å¼€å§‹åŠ è½½');
        
        let earlyLifeHistory = [];



        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        function setupFileUpload() {
            try {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                
                console.log('setupFileUpload called');
                console.log('uploadArea:', uploadArea);
                console.log('fileInput:', fileInput);
                
                if (!uploadArea || !fileInput) {
                    throw new Error('æ‰¾ä¸åˆ°ä¸Šä¼ åŒºåŸŸæˆ–æ–‡ä»¶è¾“å…¥å…ƒç´ ');
                }

                // ç¡®ä¿ä¸Šä¼ åŒºåŸŸå¯ä»¥æ¥æ”¶ç‚¹å‡»äº‹ä»¶
                uploadArea.style.pointerEvents = 'auto';
                uploadArea.style.position = 'relative';
                uploadArea.style.zIndex = '10';

                // ç§»é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„äº‹ä»¶ç›‘å¬å™¨
                uploadArea.removeEventListener('click', handleUploadAreaClick);
                fileInput.removeEventListener('change', handleFileInputChange);

                // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
                uploadArea.addEventListener('click', handleUploadAreaClick);

                // æ–‡ä»¶é€‰æ‹©å¤„ç†
                fileInput.addEventListener('change', handleFileInputChange);
                
                console.log('setupFileUpload completed successfully');
            } catch (error) {
                console.error('setupFileUpload error:', error);
                alert('æ–‡ä»¶ä¸Šä¼ è®¾ç½®å¤±è´¥: ' + error.message);
            }
        }

        // å¤„ç†ä¸Šä¼ åŒºåŸŸç‚¹å‡»
        function handleUploadAreaClick(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Upload area clicked!');
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.click();
            }
        }

        // å¤„ç†æ–‡ä»¶è¾“å…¥å˜åŒ–
        function handleFileInputChange(e) {
            console.log('File selected:', e.target.files[0]);
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œç¡®ä¿åŒä¸€æ–‡ä»¶å¯ä»¥é‡å¤é€‰æ‹©
                e.target.value = '';
            }
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(file) {
            const uploadArea = document.getElementById('uploadArea');
            const runPredictionBtn = document.querySelector('.run-prediction-btn');
            
            console.log('handleFileSelect called with:', file.name);
            console.log('File size:', file.size, 'bytes');
            console.log('File type:', file.type);
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const allowedTypes = ['.csv', '.xlsx', '.xls'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            console.log('File extension:', fileExtension);
            
            if (!allowedTypes.includes(fileExtension)) {
                alert('è¯·é€‰æ‹© CSV æˆ– Excel æ ¼å¼çš„æ–‡ä»¶');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ10MBï¼‰
            if (file.size > 10 * 1024 * 1024) {
                alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 10MB');
                return;
            }

            // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
            uploadArea.innerHTML = `
                <div class="upload-content">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="animation: spin 1s linear infinite;">
                        <path d="M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2"/>
                        <path d="M12 3C16.9706 3 21 7.02944 21 12" stroke="#1a1a1a" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <span style="color: #1a1a1a; font-weight: 500;">æ­£åœ¨è¯»å–æ–‡ä»¶...</span>
                </div>
                <div class="upload-note" style="color: #1a1a1a;">æ­£åœ¨å¤„ç† ${file.name}</div>
            `;

            // è¯»å–æ–‡ä»¶å†…å®¹
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const fileContent = e.target.result;
                    const fileData = parseFileContent(fileContent, fileExtension);
                    
                    if (fileData && fileData.length > 0) {
                        // éšè—ä¸Šä¼ åŒºåŸŸï¼Œæ˜¾ç¤ºå·²ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯
                        uploadArea.style.display = 'none';
                        
                        // åˆ›å»ºå·²ä¸Šä¼ æ–‡ä»¶æ˜¾ç¤ºåŒºåŸŸ
                        const uploadedFileDisplay = document.createElement('div');
                        uploadedFileDisplay.id = 'uploadedFileDisplay';
                        uploadedFileDisplay.className = 'uploaded-file-display';
                        uploadedFileDisplay.innerHTML = `
                            <div class="uploaded-file-info">
                                <div class="file-icon">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="#1a1a1a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M14 2V8H20" stroke="#1a1a1a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div class="file-details">
                                    <div class="file-name" onclick="previewUploadedData()" style="cursor: pointer; color: #1a1a1a; text-decoration: underline;">${file.name}</div>
                                    <div class="file-stats">å…± ${fileData.length} æ¡æ•°æ®</div>
                                </div>
                                <div class="file-actions">
                                    <button class="change-file-btn" onclick="changeUploadedFile()">æ›´æ¢æ–‡ä»¶</button>
                                </div>
                            </div>
                        `;
                        
                        // å°†æ˜¾ç¤ºåŒºåŸŸæ’å…¥åˆ°ä¸Šä¼ åŒºåŸŸçš„ä½ç½®
                        uploadArea.parentNode.insertBefore(uploadedFileDisplay, uploadArea.nextSibling);
                        
                        // å¯ç”¨é¢„æµ‹æŒ‰é’®
                        runPredictionBtn.disabled = false;
                        runPredictionBtn.style.background = '#1a1a1a';
                        runPredictionBtn.style.cursor = 'pointer';
                        
                        // ä¿å­˜é€‰æ‹©çš„æ–‡ä»¶å’Œè§£æçš„æ•°æ®
                        window.selectedFile = file;
                        window.fileData = fileData;
                        
                        console.log('File uploaded successfully:', fileData.length, 'records');
                        
                        // æ˜¾ç¤ºæ•°æ®é¢„è§ˆ
                        showDataPreview(fileData);
                    } else {
                        throw new Error('æ–‡ä»¶å†…å®¹ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
                    }
                } catch (error) {
                    console.error('æ–‡ä»¶è§£æé”™è¯¯:', error);
                    uploadArea.innerHTML = `
                        <div class="upload-content">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6 18L18 6M6 6L18 18" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span style="color: #ef4444; font-weight: 500;">æ–‡ä»¶è§£æå¤±è´¥</span>
                        </div>
                        <div class="upload-note" style="color: #ef4444;">è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®</div>
                    `;
                    runPredictionBtn.disabled = true;
                }
            };
            
            reader.onerror = function() {
                console.error('File read error');
                uploadArea.innerHTML = `
                    <div class="upload-content">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 18L18 6M6 6L18 18" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span style="color: #ef4444; font-weight: 500;">æ–‡ä»¶è¯»å–å¤±è´¥</span>
                    </div>
                    <div class="upload-note" style="color: #ef4444;">è¯·é‡æ–°é€‰æ‹©æ–‡ä»¶</div>
                `;
                runPredictionBtn.disabled = true;
            };
            
            // æ ¹æ®æ–‡ä»¶ç±»å‹è¯»å–
            if (fileExtension === '.csv') {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        // è§£ææ–‡ä»¶å†…å®¹
        function parseFileContent(content, fileExtension) {
            if (fileExtension === '.csv') {
                return parseCSV(content);
            } else {
                return parseExcel(content);
            }
        }

        // è§£æCSVæ–‡ä»¶
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
            }
            
            return data;
        }

        // è§£æExcelæ–‡ä»¶ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        function parseExcel(arrayBuffer) {
            const mockData = [];
            const sampleCount = Math.floor(Math.random() * 20) + 10;
            
            for (let i = 1; i <= sampleCount; i++) {
                mockData.push({
                    'Barcode': `BAT${String(i).padStart(3, '0')}`,
                    'Cycle': Math.floor(Math.random() * 100) + 1,
                    'Capacity': (Math.random() * 0.5 + 0.8).toFixed(3),
                    'Voltage': (Math.random() * 0.5 + 3.0).toFixed(3),
                    'Temperature': (Math.random() * 20 + 20).toFixed(1)
                });
            }
            
            return mockData;
        }

        // è¿è¡Œé¢„æµ‹åˆ†æ
        function runPrediction() {
            if (!window.selectedFile || !window.fileData) {
                alert('è¯·å…ˆé€‰æ‹©å¹¶ä¸Šä¼ æ•°æ®æ–‡ä»¶');
                return;
            }

            const runPredictionBtn = document.querySelector('.run-prediction-btn');
            const originalText = runPredictionBtn.innerHTML;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            runPredictionBtn.disabled = true;
            runPredictionBtn.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="animation: spin 1s linear infinite;">
                    <path d="M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 3C16.9706 3 21 7.02944 21 12" stroke="#1a1a1a" stroke-width="2" stroke-linecap="round"/>
                </svg>
                é¢„æµ‹åˆ†æä¸­...
            `;

            // æ•°æ®é‡‡æ ·å¤„ç† - å¯¹äºå¤§æ•°æ®é›†è¿›è¡Œé‡‡æ ·
            let dataToSend = window.fileData;
            const maxDataSize = 5000; // æœ€å¤§å‘é€5000æ¡è®°å½•
            
            if (window.fileData.length > maxDataSize) {
                console.log(`æ•°æ®é‡è¿‡å¤§ (${window.fileData.length} æ¡)ï¼Œè¿›è¡Œé‡‡æ ·å¤„ç†...`);
                
                // å‡åŒ€é‡‡æ ·
                const step = Math.floor(window.fileData.length / maxDataSize);
                dataToSend = [];
                for (let i = 0; i < window.fileData.length; i += step) {
                    dataToSend.push(window.fileData[i]);
                    if (dataToSend.length >= maxDataSize) break;
                }
                
                console.log(`é‡‡æ ·åæ•°æ®é‡: ${dataToSend.length} æ¡è®°å½•`);
            }
            
            // è°ƒç”¨åç«¯APIè¿›è¡Œé¢„æµ‹
            console.log('å¼€å§‹è°ƒç”¨é¢„æµ‹API...');
            console.log('å‘é€çš„æ•°æ®é‡:', dataToSend.length);
            
            fetch('/api/early-life-prediction', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    data: dataToSend
                })
            })
            .then(response => {
                console.log('APIå“åº”çŠ¶æ€:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('APIè¿”å›æ•°æ®:', data);
                
                if (data.success) {
                    console.log('é¢„æµ‹æˆåŠŸï¼Œå¼€å§‹å¤„ç†ç»“æœ...');
                    
                    // æ·»åŠ åˆ°å†å²è®°å½•
                    const historyItem = {
                        id: Date.now(),
                        timestamp: new Date().toLocaleString('zh-CN'),
                        fileName: window.selectedFile.name,
                        results: data.results.slice(0, 100), // åªä¿å­˜å‰100ä¸ªç»“æœ
                        summary: data.summary
                    };
                    
                    earlyLifeHistory.unshift(historyItem);
                    // é™åˆ¶å†å²è®°å½•æ•°é‡ï¼Œåªä¿ç•™æœ€è¿‘10æ¡
                    if (earlyLifeHistory.length > 10) {
                        earlyLifeHistory = earlyLifeHistory.slice(0, 10);
                    }
                    updateHistoryDisplay();
                    saveHistoryToStorage();
                    
                    // ç›´æ¥æ˜¾ç¤ºç»“æœåœ¨é¡µé¢ä¸Š
                    showPredictionResults({
                        fileName: window.selectedFile.name,
                        results: data.results,
                        summary: data.summary,
                        originalData: window.fileData
                    });
                    
                    console.log('ç»“æœå¤„ç†å®Œæˆ');
                } else {
                    throw new Error(data.message || 'é¢„æµ‹å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('é¢„æµ‹è¯·æ±‚å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.stack);
                
                // æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                let errorMessage = 'é¢„æµ‹åˆ†æå¤±è´¥';
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€';
                } else if (error.message.includes('HTTP')) {
                    errorMessage = `æœåŠ¡å™¨é”™è¯¯: ${error.message}`;
                } else {
                    errorMessage = error.message;
                }
                
                alert(errorMessage);
            })
            .finally(() => {
                console.log('é¢„æµ‹æµç¨‹ç»“æŸï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€');
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                runPredictionBtn.disabled = false;
                runPredictionBtn.innerHTML = originalText;
            });
        }

        // ç”Ÿæˆé¢„æµ‹ç»“æœ
        function generatePredictionResults(fileData) {
            const results = [];
            
            fileData.forEach((row, index) => {
                const barcode = row.Barcode || row.barcode || `BAT${String(index + 1).padStart(3, '0')}`;
                let cycleLife = 300;
                let explanation = 'åŸºäºæ—©æœŸå¾ªç¯æ•°æ®é¢„æµ‹';
                
                if (row.Capacity || row.capacity) {
                    const capacity = parseFloat(row.Capacity || row.capacity);
                    if (capacity > 0.9) {
                        cycleLife = Math.floor(Math.random() * 200) + 400;
                        explanation = 'åŸºäºå®¹é‡ä¿æŒç‡åˆ†æï¼Œç”µæ± æ€§èƒ½ä¼˜ç§€';
                    } else if (capacity > 0.8) {
                        cycleLife = Math.floor(Math.random() * 150) + 300;
                        explanation = 'æ ¹æ®å®¹é‡è¡°å‡è¶‹åŠ¿é¢„æµ‹ï¼Œæ€§èƒ½ç¨³å®š';
                    } else {
                        cycleLife = Math.floor(Math.random() * 100) + 200;
                        explanation = 'å®¹é‡è¡°å‡è¾ƒå¿«ï¼Œéœ€è¦å…³æ³¨ç”µæ± å¥åº·çŠ¶æ€';
                    }
                }
                
                results.push({
                    barcode: barcode,
                    cycleLife: Math.max(100, Math.min(800, cycleLife)),
                    explanation: explanation
                });
            });
            
            return results;
        }

        // æ˜¾ç¤ºæ•°æ®é¢„è§ˆ
        function showDataPreview(fileData) {
            const resultsPreview = document.getElementById('resultsPreview');
            if (resultsPreview && fileData.length > 0) {
                const headers = Object.keys(fileData[0]);
                const previewData = fileData.slice(0, 3); // åªæ˜¾ç¤ºå‰3è¡Œ
                
                let tableHTML = `
                    <div class="preview-header">
                        <span>æ•°æ®é¢„è§ˆ (å‰${previewData.length}è¡Œ)</span>
                    </div>
                    <div class="results-table">
                        <table>
                            <thead>
                                <tr>
                `;
                
                headers.forEach(header => {
                    tableHTML += `<th>${header}</th>`;
                });
                
                tableHTML += `
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                previewData.forEach(row => {
                    tableHTML += '<tr>';
                    headers.forEach(header => {
                        tableHTML += `<td>${row[header] || ''}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                
                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                resultsPreview.innerHTML = tableHTML;
                
                // éšè—é¢„æµ‹æ‘˜è¦
                document.getElementById('predictionSummary').style.display = 'none';
            }
        }

        // é‡ç½®æ–‡ä»¶ä¸Šä¼ 
        function resetFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const runPredictionBtn = document.querySelector('.run-prediction-btn');
            
            uploadArea.innerHTML = `
                <div class="upload-content">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M17 8L12 3L7 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 3V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶</span>
                </div>
                <div class="upload-note">æ”¯æŒ CSVã€Excel æ ¼å¼ï¼Œå•æ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 10MB</div>
            `;
            
            fileInput.value = '';
            runPredictionBtn.disabled = true;
            runPredictionBtn.style.background = '#9ca3af';
            runPredictionBtn.style.cursor = 'not-allowed';
            
            window.selectedFile = null;
            window.fileData = null;
            
            // é‡ç½®ç»“æœå±•ç¤ºåŒºåŸŸ
            const resultsPreview = document.getElementById('resultsPreview');
            resultsPreview.style.display = 'none';
            
            // éšè—é¢„æµ‹æ‘˜è¦
            document.getElementById('predictionSummary').style.display = 'none';
            
            // é‡æ–°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            setupFileUpload();
        }

        // ç›´æ¥æ˜¾ç¤ºé¢„æµ‹ç»“æœåœ¨é¡µé¢ä¸Š
        function showPredictionResults(result) {
            const resultsPreview = document.getElementById('resultsPreview');
            const predictionSummary = document.getElementById('predictionSummary');
            
            // æ›´æ–°ç»“æœè¡¨æ ¼
            let tableHTML = `
                <h4 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1rem; font-weight: 600;">
                    é¢„æµ‹ç»“æœ
                </h4>
                <div class="results-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Barcode</th>
                                <th>Cycle Life</th>
                                <th class="explanation-header">Explanation</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // å¯¹barcodeè¿›è¡Œå»é‡ï¼Œæ¯ä¸ªbarcodeåªæ˜¾ç¤ºä¸€æ¬¡
            const uniqueResults = [];
            const seenBarcodes = new Set();
            
            result.results.forEach(item => {
                if (!seenBarcodes.has(item.barcode)) {
                    seenBarcodes.add(item.barcode);
                    uniqueResults.push(item);
                }
            });
            
            // æ˜¾ç¤ºå‰10ä¸ªå»é‡åçš„ç»“æœ
            const displayResults = uniqueResults.slice(0, 10);
            
            displayResults.forEach(item => {
                tableHTML += `
                    <tr>
                        <td>${item.barcode || 'N/A'}</td>
                        <td><strong>${item.cycleLife || 'N/A'}</strong></td>
                        <td style="color: #475569;">${item.explanation || 'N/A'}</td>
                    </tr>
                `;
            });
            
            if (uniqueResults.length > 10) {
                tableHTML += `
                    <tr>
                        <td colspan="3" style="text-align: center; color: #6b7280; font-style: italic;">
                            è¿˜æœ‰ ${uniqueResults.length - 10} ä¸ªç”µèŠ¯æœªæ˜¾ç¤º...
                        </td>
                    </tr>
                `;
            }
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            resultsPreview.innerHTML = tableHTML;
            resultsPreview.style.display = 'block';
            
            // æ›´æ–°é¢„æµ‹æ‘˜è¦
            if (result.summary) {
                // è®¡ç®—å»é‡åçš„ç”µèŠ¯æ•°é‡
                const uniqueBarcodes = new Set(result.results.map(item => item.barcode));
                const uniqueSampleCount = uniqueBarcodes.size;
                
                document.getElementById('totalSamples').textContent = `${uniqueSampleCount} ä¸ª`;
                document.getElementById('avgCycleLife').textContent = `${result.summary.averageCycleLife} æ¬¡`;
                document.getElementById('predictionTime').textContent = new Date(result.summary.predictionTime).toLocaleString('zh-CN');
                predictionSummary.style.display = 'block';
            }
            

            
            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            resultsPreview.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }



        // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            if (earlyLifeHistory.length === 0) {
                historyList.innerHTML = '<div class="empty-history">æš‚æ— é¢„æµ‹è®°å½•</div>';
                return;
            }

            earlyLifeHistory.forEach(item => {
                const avgCycleLife = item.summary?.averageCycleLife || 
                    Math.round(item.results.reduce((sum, r) => sum + r.cycleLife, 0) / item.results.length);
                
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-item-header">
                        <span class="history-time">${item.timestamp}</span>
                        <span class="history-status å®Œæˆ">å®Œæˆ</span>
                    </div>
                    <div class="history-item-content">
                        <div class="history-file">${item.fileName}</div>
                        <div class="history-result">
                            <span>é¢„æµ‹äº† ${item.results.length} ä¸ªç”µèŠ¯</span>
                            <span class="avg-cycle-life">å¹³å‡å¯¿å‘½: ${avgCycleLife} æ¬¡</span>
                        </div>
                    </div>
                    <div class="history-item-actions">
                        <button class="view-result-btn" onclick="viewHistoryResult(${item.id})">æŸ¥çœ‹</button>
                        <button class="delete-history-btn" onclick="deleteHistoryItem(${item.id})">åˆ é™¤</button>
                    </div>
                `;
                historyList.appendChild(historyItem);
            });
        }

        // æŸ¥çœ‹å†å²è®°å½•ç»“æœ
        function viewHistoryResult(id) {
            const item = earlyLifeHistory.find(h => h.id === id);
            if (item) {
                showHistoryResultModal(item);
            }
        }

        // æ˜¾ç¤ºå†å²è®°å½•ç»“æœå¼¹çª—
        function showHistoryResultModal(item) {
            // åˆ›å»ºå¼¹çª—
            const modal = document.createElement('div');
            modal.id = 'historyResultModal';
            modal.className = 'history-result-modal';
            
            // ç”µèŠ¯å»é‡ï¼Œç›¸åŒç”µèŠ¯åªä¿ç•™ä¸€æ¡ç»“æœ
            const uniqueResults = [];
            const seenBarcodes = new Set();
            
            item.results.forEach(result => {
                if (!seenBarcodes.has(result.barcode)) {
                    seenBarcodes.add(result.barcode);
                    uniqueResults.push(result);
                }
            });
            
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeHistoryResultModal()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>é¢„æµ‹ç»“æœè¯¦æƒ… - ${item.fileName}</h3>
                        <button class="close-btn" onclick="closeHistoryResultModal()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <!-- é¢„æµ‹ç»“æœéƒ¨åˆ† -->
                        <div class="result-section">
                            <h4>é¢„æµ‹ç»“æœ</h4>
                            <div class="prediction-summary">
                                <div class="summary-item">
                                    <span class="summary-label">ç”µèŠ¯æ•°é‡:</span>
                                    <span class="summary-value">${uniqueResults.length}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">å¹³å‡å¾ªç¯å¯¿å‘½:</span>
                                    <span class="summary-value">${item.summary.averageCycleLife} æ¬¡</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">é¢„æµ‹æ—¶é—´:</span>
                                    <span class="summary-value">${new Date(item.summary.predictionTime).toLocaleString('zh-CN')}</span>
                                </div>
                            </div>
                            
                            <div class="results-table-container">
                                <table class="results-table">
                                    <thead>
                                        <tr>
                                            <th>ç”µèŠ¯ç¼–å·</th>
                                            <th>é¢„æµ‹å¾ªç¯å¯¿å‘½</th>
                                            <th>è¯´æ˜</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${uniqueResults.slice(0, 10).map(result => `
                                            <tr>
                                                <td>${result.barcode}</td>
                                                <td>${result.cycleLife} æ¬¡</td>
                                                <td>${result.explanation}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                ${uniqueResults.length > 10 ? `<p class="data-note">æ³¨: ä»…æ˜¾ç¤ºå‰ 10 ä¸ªç”µèŠ¯ï¼Œå®Œæ•´æ•°æ®å…± ${uniqueResults.length} ä¸ªç”µèŠ¯</p>` : ''}
                            </div>
                        </div>
                        
                        <!-- åŸå§‹æ•°æ®éƒ¨åˆ† -->
                        <div class="data-section">
                            <h4>åŸå§‹æ•°æ®</h4>
                            <div class="data-attachment-container">
                                <div class="attachment-item">
                                    <div class="attachment-icon">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="#1a1a1a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M14 2V8H20" stroke="#1a1a1a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </div>
                                    <div class="attachment-details">
                                        <div class="attachment-name">${item.fileName}</div>
                                        <div class="attachment-info">åŸå§‹æ•°æ®æ–‡ä»¶ - ${generateSampleData(uniqueResults.length).length} æ¡è®°å½•</div>
                                    </div>
                                    <button class="attachment-download-btn" onclick="downloadOriginalData('${item.fileName}', ${JSON.stringify(generateSampleData(uniqueResults.length))})">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        ä¸‹è½½
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
        }

        // å…³é—­å†å²è®°å½•ç»“æœå¼¹çª—
        function closeHistoryResultModal() {
            const modal = document.getElementById('historyResultModal');
            if (modal) {
                document.body.removeChild(modal);
                document.body.style.overflow = 'auto';
            }
        }

        // ç”Ÿæˆç¤ºä¾‹æ•°æ®ç”¨äºæ˜¾ç¤º
        function generateSampleData(count) {
            const data = [];
            const barcodes = ['BAT001', 'BAT002', 'BAT003', 'BAT004', 'BAT005'];
            
            for (let i = 0; i < count * 10; i++) {
                const barcode = barcodes[i % barcodes.length];
                data.push({
                    barcode: barcode,
                    cycle_id: Math.floor(i / 10) + 1,
                    current: (Math.random() * 2 + 1).toFixed(3),
                    voltage: (Math.random() * 0.5 + 3.2).toFixed(3),
                    time: Math.floor(Math.random() * 3600)
                });
            }
            return data;
        }

        // ä¸‹è½½åŸå§‹æ•°æ®
        function downloadOriginalData(fileName, data) {
            // åˆ›å»ºCSVå†…å®¹
            const headers = ['barcode', 'cycle_id', 'current', 'voltage', 'time'];
            const csvContent = [
                headers.join(','),
                ...data.map(row => [
                    row.barcode,
                    row.cycle_id,
                    row.current,
                    row.voltage,
                    row.time
                ].join(','))
            ].join('\n');
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', fileName.replace('.csv', '_original.csv'));
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // æ¸…ç†URLå¯¹è±¡
            URL.revokeObjectURL(url);
            
            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            alert(`åŸå§‹æ•°æ®å·²ä¸‹è½½ï¼æ–‡ä»¶åä¸ºï¼š${fileName.replace('.csv', '_original.csv')}`);
        }

        // åˆ é™¤å†å²è®°å½•é¡¹
        function deleteHistoryItem(id) {
            earlyLifeHistory = earlyLifeHistory.filter(h => h.id !== id);
            updateHistoryDisplay();
            saveHistoryToStorage();
        }

        // æ¸…ç©ºå†å²è®°å½•
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é¢„æµ‹è®°å½•å—ï¼Ÿ')) {
                earlyLifeHistory = [];
                updateHistoryDisplay();
                saveHistoryToStorage();
            }
        }

        // ä¿å­˜å†å²è®°å½•åˆ°æœ¬åœ°å­˜å‚¨
        function saveHistoryToStorage() {
            try {
                // é™åˆ¶å†å²è®°å½•æ•°é‡ï¼Œåªä¿ç•™æœ€è¿‘20æ¡
                const limitedHistory = earlyLifeHistory.slice(0, 20);
                localStorage.setItem('earlyLifeHistory', JSON.stringify(limitedHistory));
            } catch (error) {
                console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', error);
                // å¦‚æœå­˜å‚¨å¤±è´¥ï¼Œå°è¯•æ¸…ç†æ›´å¤šå†å²è®°å½•
                try {
                    const limitedHistory = earlyLifeHistory.slice(0, 10);
                    localStorage.setItem('earlyLifeHistory', JSON.stringify(limitedHistory));
                } catch (secondError) {
                    console.error('æ¸…ç†åä»ç„¶æ— æ³•ä¿å­˜:', secondError);
                    // å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œæ¸…ç©ºæ‰€æœ‰å†å²è®°å½•
                    localStorage.removeItem('earlyLifeHistory');
                    earlyLifeHistory = [];
                }
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å†å²è®°å½•
        function loadHistoryFromStorage() {
            const saved = localStorage.getItem('earlyLifeHistory');
            if (saved) {
                earlyLifeHistory = JSON.parse(saved);
                updateHistoryDisplay();
            }
        }

        // æ·»åŠ è™šæ‹Ÿå†å²è®°å½•
        function addVirtualHistory() {
            const virtualRecords = [
                {
                    id: Date.now() - 86400000,
                    timestamp: new Date(Date.now() - 86400000).toLocaleString('zh-CN'),
                    fileName: 'battery_data_001.csv',
                    results: [
                        { 
                            barcode: 'BAT001', 
                            cycleLife: 450, 
                            confidence: 0.85,
                            explanation: 'å®¹é‡ä¿æŒç‡ä¼˜ç§€ï¼Œé¢„æµ‹å¯¿å‘½è¾ƒé•¿',
                            features: { capacity: '0.985', voltage: '3.65', temperature: '25.2', cycle: '5' }
                        },
                        { 
                            barcode: 'BAT002', 
                            cycleLife: 380, 
                            confidence: 0.78,
                            explanation: 'å®¹é‡ä¿æŒç‡è‰¯å¥½ï¼Œæ€§èƒ½ç¨³å®š',
                            features: { capacity: '0.972', voltage: '3.62', temperature: '26.1', cycle: '8' }
                        }
                    ],
                    summary: {
                        totalSamples: 2,
                        averageCycleLife: 415,
                        predictionTime: new Date(Date.now() - 86400000).toISOString()
                    }
                },
                {
                    id: Date.now() - 172800000,
                    timestamp: new Date(Date.now() - 172800000).toLocaleString('zh-CN'),
                    fileName: 'battery_data_002.csv',
                    results: [
                        { 
                            barcode: 'BAT003', 
                            cycleLife: 520, 
                            confidence: 0.92,
                            explanation: 'å®¹é‡ä¿æŒç‡ä¼˜ç§€ï¼Œé¢„æµ‹å¯¿å‘½è¾ƒé•¿',
                            features: { capacity: '0.958', voltage: '3.58', temperature: '24.8', cycle: '12' }
                        },
                        { 
                            barcode: 'BAT004', 
                            cycleLife: 410, 
                            confidence: 0.75,
                            explanation: 'å®¹é‡ä¿æŒç‡è‰¯å¥½ï¼Œæ€§èƒ½ç¨³å®š',
                            features: { capacity: '0.945', voltage: '3.55', temperature: '25.5', cycle: '15' }
                        }
                    ],
                    summary: {
                        totalSamples: 2,
                        averageCycleLife: 465,
                        predictionTime: new Date(Date.now() - 172800000).toISOString()
                    }
                }
            ];
            
            earlyLifeHistory = virtualRecords;
            updateHistoryDisplay();
            saveHistoryToStorage();
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded event fired');
            try {
                loadHistoryFromStorage();
                setupFileUpload();
                
                if (earlyLifeHistory.length === 0) {
                    addVirtualHistory();
                }
                

                
                // è¿è¡Œè°ƒè¯•æ£€æŸ¥
                setTimeout(() => {
                    console.log('\n=== è¿è¡Œè°ƒè¯•æ£€æŸ¥ ===');
                    runAllChecks();
                }, 1000);
                
                console.log('æ‰€æœ‰åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('åˆå§‹åŒ–é”™è¯¯:', error);
                alert('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        });

        // è°ƒè¯•å‡½æ•°
        function runAllChecks() {
            console.log('å¼€å§‹è¿è¡Œè°ƒè¯•æ£€æŸ¥...\n');
            
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            console.log('1. å…ƒç´ æ£€æŸ¥:');
            console.log('uploadArea:', uploadArea);
            console.log('fileInput:', fileInput);
            
            if (uploadArea) {
                console.log('uploadArea.style.pointerEvents:', uploadArea.style.pointerEvents);
                console.log('uploadArea.style.zIndex:', uploadArea.style.zIndex);
            }
            
            console.log('\n2. å‡½æ•°æ£€æŸ¥:');
            console.log('setupFileUpload:', typeof setupFileUpload === 'function' ? 'âœ…' : 'âŒ');
            console.log('handleUploadAreaClick:', typeof handleUploadAreaClick === 'function' ? 'âœ…' : 'âŒ');
            console.log('handleFileInputChange:', typeof handleFileInputChange === 'function' ? 'âœ…' : 'âŒ');
            console.log('handleFileSelect:', typeof handleFileSelect === 'function' ? 'âœ…' : 'âŒ');
            
            console.log('\n3. å…¨å±€å˜é‡æ£€æŸ¥:');
            console.log('window.selectedFile:', window.selectedFile);
            console.log('window.fileData:', window.fileData);
            
            console.log('\n=== è°ƒè¯•æ£€æŸ¥å®Œæˆ ===');
        }

        // æµ‹è¯•ç‚¹å‡»åŠŸèƒ½
        function testClick() {
            console.log('æµ‹è¯•ç‚¹å‡»åŠŸèƒ½...');
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            if (uploadArea && fileInput) {
                console.log('æ¨¡æ‹Ÿç‚¹å‡»ä¸Šä¼ åŒºåŸŸ');
                fileInput.click();
            } else {
                console.log('âŒ æ‰¾ä¸åˆ°å¿…è¦çš„å…ƒç´ ');
            }
        }



        // ä¸‹è½½æ ·ä¾‹æ•°æ®
        function downloadSampleData() {
            // åˆ›å»ºæ ·ä¾‹æ•°æ®
            const sampleData = [
                {
                    barcode: 'BAT001',
                    cycle_id: '1',
                    current: '2.5',
                    voltage: '3.65',
                    time: '120'
                },
                {
                    barcode: 'BAT001',
                    cycle_id: '1',
                    current: '2.3',
                    voltage: '3.62',
                    time: '125'
                },
                {
                    barcode: 'BAT001',
                    cycle_id: '1',
                    current: '2.1',
                    voltage: '3.58',
                    time: '130'
                },
                {
                    barcode: 'BAT002',
                    cycle_id: '2',
                    current: '2.4',
                    voltage: '3.64',
                    time: '118'
                },
                {
                    barcode: 'BAT002',
                    cycle_id: '2',
                    current: '2.2',
                    voltage: '3.60',
                    time: '122'
                },
                {
                    barcode: 'BAT003',
                    cycle_id: '3',
                    current: '2.6',
                    voltage: '3.66',
                    time: '115'
                },
                {
                    barcode: 'BAT003',
                    cycle_id: '3',
                    current: '2.4',
                    voltage: '3.63',
                    time: '120'
                },
                {
                    barcode: 'BAT003',
                    cycle_id: '3',
                    current: '2.0',
                    voltage: '3.59',
                    time: '125'
                }
            ];
            
            // è½¬æ¢ä¸ºCSVæ ¼å¼
            const headers = Object.keys(sampleData[0]);
            const csvContent = [
                headers.join(','),
                ...sampleData.map(row => headers.map(header => row[header]).join(','))
            ].join('\n');
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'æ ·ä¾‹æ•°æ®.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            alert('æ ·ä¾‹æ•°æ®å·²ä¸‹è½½ï¼æ–‡ä»¶åä¸ºï¼šæ ·ä¾‹æ•°æ®.csv');
        }

        // æ•°æ®é¢„è§ˆå¼¹çª—
        function previewUploadedData() {
            if (!window.fileData || window.fileData.length === 0) {
                alert('æ²¡æœ‰å¯é¢„è§ˆçš„æ•°æ®');
                return;
            }
            
            // åˆ›å»ºå¼¹çª—
            const modal = document.createElement('div');
            modal.id = 'dataPreviewModal';
            modal.className = 'data-preview-modal';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeDataPreview()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>æ•°æ®é¢„è§ˆ - ${window.selectedFile.name}</h3>
                        <button class="close-btn" onclick="closeDataPreview()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <div class="data-table-container">
                            <table class="data-preview-table">
                                <thead>
                                    <tr>
                                        ${Object.keys(window.fileData[0] || {}).map(key => `<th>${key}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${window.fileData.slice(0, 20).map(row => `
                                        <tr>
                                            ${Object.values(row).map(value => `<td>${value}</td>`).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ${window.fileData.length > 20 ? `<p class="data-note">æ³¨: ä»…æ˜¾ç¤ºå‰ 20 æ¡è®°å½•ï¼Œå®Œæ•´æ•°æ®å…± ${window.fileData.length} æ¡</p>` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
        }
        
        // å…³é—­æ•°æ®é¢„è§ˆå¼¹çª—
        function closeDataPreview() {
            const modal = document.getElementById('dataPreviewModal');
            if (modal) {
                document.body.removeChild(modal);
                document.body.style.overflow = 'auto';
            }
        }
        
        // æ›´æ¢ä¸Šä¼ æ–‡ä»¶
        function changeUploadedFile() {
            // ç§»é™¤å·²ä¸Šä¼ æ–‡ä»¶æ˜¾ç¤º
            const uploadedFileDisplay = document.getElementById('uploadedFileDisplay');
            if (uploadedFileDisplay) {
                uploadedFileDisplay.remove();
            }
            
            // æ˜¾ç¤ºä¸Šä¼ åŒºåŸŸ
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                uploadArea.style.display = 'block';
            }
            
            // é‡ç½®æ–‡ä»¶æ•°æ®
            window.selectedFile = null;
            window.fileData = null;
            
            // ç¦ç”¨é¢„æµ‹æŒ‰é’®
            const runPredictionBtn = document.querySelector('.run-prediction-btn');
            if (runPredictionBtn) {
                runPredictionBtn.disabled = true;
                runPredictionBtn.style.background = '#9ca3af';
                runPredictionBtn.style.cursor = 'not-allowed';
            }
        }

        // æ¨¡å‹é€‰æ‹©åŠŸèƒ½
        function selectModel(modelType) {
            // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.model-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // æ·»åŠ é€‰ä¸­çŠ¶æ€åˆ°å½“å‰é€‰é¡¹
            const selectedOption = document.querySelector(`[data-model="${modelType}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
            
            // å­˜å‚¨é€‰ä¸­çš„æ¨¡å‹
            window.selectedModel = modelType;
        }

        // æ­¥éª¤åˆ‡æ¢åŠŸèƒ½
        function switchToStep(stepNumber) {
            // éšè—æ‰€æœ‰æ­¥éª¤
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('predictionSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            
            // ç§»é™¤æ‰€æœ‰æ­¥éª¤çš„activeçŠ¶æ€
            document.querySelectorAll('.step-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // æ˜¾ç¤ºå¯¹åº”æ­¥éª¤
            switch(stepNumber) {
                case 1:
                    document.getElementById('uploadSection').style.display = 'block';
                    document.querySelector('.step-item:nth-child(1)').classList.add('active');
                    break;
                case 2:
                    document.getElementById('predictionSection').style.display = 'block';
                    document.querySelector('.step-item:nth-child(3)').classList.add('active');
                    break;
                case 3:
                    document.getElementById('resultsSection').style.display = 'block';
                    document.querySelector('.step-item:nth-child(5)').classList.add('active');
                    break;
            }
        }

        // ä¿®æ”¹æ–‡ä»¶ä¸Šä¼ å¤„ç†å‡½æ•°
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            window.selectedFile = file;
            
            // è¯»å–æ–‡ä»¶å†…å®¹
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const lines = csvContent.split('\n');
                    const headers = lines[0].split(',');
                    const data = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = lines[i].split(',');
                            const row = {};
                            headers.forEach((header, index) => {
                                row[header.trim()] = values[index] ? values[index].trim() : '';
                            });
                            data.push(row);
                        }
                    }
                    
                    window.fileData = data;
                    
                    // æ˜¾ç¤ºå·²ä¸Šä¼ æ•°æ®
                    showUploadedData(file, data);
                    
                } catch (error) {
                    console.error('æ–‡ä»¶è§£æé”™è¯¯:', error);
                    alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·ä¸Šä¼ æ­£ç¡®çš„CSVæ–‡ä»¶');
                }
            };
            reader.readAsText(file);
        }

        // æ˜¾ç¤ºå·²ä¸Šä¼ æ•°æ®
        function showUploadedData(file, data) {
            const uploadSection = document.getElementById('uploadSection');
            const uploadedDataSection = document.getElementById('uploadedDataSection');
            const startPredictionBtn = document.getElementById('startPredictionBtn');
            
            // éšè—ä¸Šä¼ åŒºåŸŸ
            uploadSection.style.display = 'none';
            
            // æ˜¾ç¤ºå·²ä¸Šä¼ æ•°æ®åŒºåŸŸ
            uploadedDataSection.style.display = 'block';
            
            // æ›´æ–°æ–‡ä»¶æ˜¾ç¤º
            const uploadedFileDisplay = document.getElementById('uploadedFileDisplay');
            uploadedFileDisplay.innerHTML = `
                <div class="uploaded-file-info">
                    <div class="file-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="#1a1a1a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M14 2V8H20" stroke="#1a1a1a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="file-details">
                        <div class="file-name" onclick="previewUploadedData()" style="cursor: pointer; color: #1a1a1a; text-decoration: underline;">${file.name}</div>
                        <div class="file-stats">å…± ${data.length} æ¡æ•°æ®</div>
                    </div>
                    <div class="file-actions">
                        <button class="change-file-btn" onclick="changeUploadedFile()">æ›´æ¢æ–‡ä»¶</button>
                    </div>
                </div>
            `;
            
            // æ˜¾ç¤ºå¼€å§‹é¢„æµ‹æŒ‰é’®
            startPredictionBtn.style.display = 'block';
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            updateStepIndicator(2);
        }

        // å¼€å§‹é¢„æµ‹
        function startPrediction() {
            if (!window.fileData || window.fileData.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ æ•°æ®æ–‡ä»¶');
                return;
            }
            
            // éšè—å·²ä¸Šä¼ æ•°æ®åŒºåŸŸï¼Œæ˜¾ç¤ºé¢„æµ‹è¿›åº¦
            const uploadedDataSection = document.getElementById('uploadedDataSection');
            const predictionProgressSection = document.getElementById('predictionProgressSection');
            
            uploadedDataSection.style.display = 'none';
            predictionProgressSection.style.display = 'block';
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            updateStepIndicator(3);
            
            // å¼€å§‹è¿›åº¦åŠ¨ç”»
            startProgressAnimation();
            
            // æ‰§è¡Œé¢„æµ‹
            executePrediction();
        }

        // å¼€å§‹è¿›åº¦åŠ¨ç”»
        function startProgressAnimation() {
            const progressFill = document.getElementById('progressFill');
            const progressStatus = document.getElementById('progressStatus');
            const statuses = [
                'æ­£åœ¨åˆå§‹åŒ–æ¨¡å‹...',
                'æ­£åœ¨åˆ†ææ•°æ®ç‰¹å¾...',
                'æ­£åœ¨è®­ç»ƒé¢„æµ‹æ¨¡å‹...',
                'æ­£åœ¨ç”Ÿæˆé¢„æµ‹ç»“æœ...',
                'æ­£åœ¨ä¼˜åŒ–é¢„æµ‹ç²¾åº¦...',
                'é¢„æµ‹å®Œæˆï¼'
            ];
            
            let currentStep = 0;
            const totalSteps = statuses.length - 1;
            
            const interval = setInterval(() => {
                const progress = (currentStep / totalSteps) * 100;
                progressFill.style.width = progress + '%';
                progressStatus.textContent = statuses[currentStep];
                
                currentStep++;
                
                if (currentStep > totalSteps) {
                    clearInterval(interval);
                    setTimeout(() => {
                        showPredictionResults();
                    }, 1000);
                }
            }, 800);
        }

        // æ‰§è¡Œé¢„æµ‹
        function executePrediction() {
            // æ•°æ®é‡‡æ ·å¤„ç† - å¯¹äºå¤§æ•°æ®é›†è¿›è¡Œé‡‡æ ·
            let dataToSend = window.fileData;
            const maxDataSize = 5000; // æœ€å¤§å‘é€5000æ¡è®°å½•
            
            if (window.fileData.length > maxDataSize) {
                console.log(`æ•°æ®é‡è¿‡å¤§ (${window.fileData.length} æ¡)ï¼Œè¿›è¡Œé‡‡æ ·å¤„ç†...`);
                
                // å‡åŒ€é‡‡æ ·
                const step = Math.floor(window.fileData.length / maxDataSize);
                dataToSend = [];
                for (let i = 0; i < window.fileData.length; i += step) {
                    dataToSend.push(window.fileData[i]);
                    if (dataToSend.length >= maxDataSize) break;
                }
                
                console.log(`é‡‡æ ·åæ•°æ®é‡: ${dataToSend.length} æ¡è®°å½•`);
            }
            
            // è°ƒç”¨åç«¯APIè¿›è¡Œé¢„æµ‹
            console.log('å¼€å§‹è°ƒç”¨é¢„æµ‹API...');
            console.log('å‘é€çš„æ•°æ®é‡:', dataToSend.length);
            
            fetch('/api/early-life-prediction', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    data: dataToSend
                })
            })
            .then(response => {
                console.log('APIå“åº”çŠ¶æ€:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('APIè¿”å›æ•°æ®:', data);
                
                if (data.success) {
                    console.log('é¢„æµ‹æˆåŠŸï¼Œå¼€å§‹å¤„ç†ç»“æœ...');
                    
                    // æ·»åŠ åˆ°å†å²è®°å½•
                    const historyItem = {
                        id: Date.now(),
                        timestamp: new Date().toLocaleString('zh-CN'),
                        fileName: window.selectedFile.name,
                        results: data.results.slice(0, 100), // åªä¿å­˜å‰100ä¸ªç»“æœ
                        summary: data.summary
                    };
                    
                    earlyLifeHistory.unshift(historyItem);
                    // é™åˆ¶å†å²è®°å½•æ•°é‡ï¼Œåªä¿ç•™æœ€è¿‘10æ¡
                    if (earlyLifeHistory.length > 10) {
                        earlyLifeHistory = earlyLifeHistory.slice(0, 10);
                    }
                    updateHistoryDisplay();
                    saveHistoryToStorage();
                    
                    // ä¿å­˜é¢„æµ‹ç»“æœ
                    window.predictionResults = {
                        fileName: window.selectedFile.name,
                        results: data.results,
                        summary: data.summary,
                        originalData: window.fileData
                    };
                    
                    console.log('ç»“æœå¤„ç†å®Œæˆ');
                } else {
                    throw new Error(data.message || 'é¢„æµ‹å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('é¢„æµ‹è¯·æ±‚å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.stack);
                
                // æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                let errorMessage = 'é¢„æµ‹åˆ†æå¤±è´¥';
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€';
                } else if (error.message.includes('HTTP')) {
                    errorMessage = `æœåŠ¡å™¨é”™è¯¯: ${error.message}`;
                } else {
                    errorMessage = error.message;
                }
                
                alert(errorMessage);
                
                // è¿”å›å·²ä¸Šä¼ æ•°æ®çŠ¶æ€
                const predictionProgressSection = document.getElementById('predictionProgressSection');
                const uploadedDataSection = document.getElementById('uploadedDataSection');
                
                predictionProgressSection.style.display = 'none';
                uploadedDataSection.style.display = 'block';
                updateStepIndicator(2);
            });
        }

        // æ˜¾ç¤ºé¢„æµ‹ç»“æœ
        function showPredictionResults() {
            const predictionProgressSection = document.getElementById('predictionProgressSection');
            const predictionResultsSection = document.getElementById('predictionResultsSection');
            
            // éšè—è¿›åº¦åŒºåŸŸï¼Œæ˜¾ç¤ºç»“æœåŒºåŸŸ
            predictionProgressSection.style.display = 'none';
            predictionResultsSection.style.display = 'block';
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            updateStepIndicator(4);
            
            // å¦‚æœæœ‰ä¿å­˜çš„é¢„æµ‹ç»“æœï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ç”Ÿæˆæ¨¡æ‹Ÿç»“æœ
            const results = window.predictionResults || {
                fileName: window.selectedFile.name,
                results: [
                    { barcode: 'BAT001', cycleLife: 450, explanation: 'å®¹é‡ä¿æŒç‡ä¼˜ç§€ï¼Œé¢„æµ‹å¯¿å‘½è¾ƒé•¿' },
                    { barcode: 'BAT002', cycleLife: 380, explanation: 'å®¹é‡ä¿æŒç‡è‰¯å¥½ï¼Œæ€§èƒ½ç¨³å®š' }
                ],
                summary: {
                    totalSamples: 2,
                    averageCycleLife: 415,
                    predictionTime: new Date().toISOString()
                }
            };
            
            // æ˜¾ç¤ºç»“æœ
            displayPredictionResults(results);
        }

        // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
        function updateStepIndicator(step) {
            // ç§»é™¤æ‰€æœ‰æ­¥éª¤çš„activeçŠ¶æ€
            document.querySelectorAll('.step-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // æ ¹æ®æ­¥éª¤æ·»åŠ activeçŠ¶æ€
            switch(step) {
                case 1:
                    document.querySelector('.step-item:nth-child(1)').classList.add('active');
                    break;
                case 2:
                    document.querySelector('.step-item:nth-child(1)').classList.add('active');
                    document.querySelector('.step-item:nth-child(3)').classList.add('active');
                    break;
                case 3:
                    document.querySelector('.step-item:nth-child(1)').classList.add('active');
                    document.querySelector('.step-item:nth-child(3)').classList.add('active');
                    document.querySelector('.step-item:nth-child(5)').classList.add('active');
                    break;
                case 4:
                    document.querySelector('.step-item:nth-child(1)').classList.add('active');
                    document.querySelector('.step-item:nth-child(3)').classList.add('active');
                    document.querySelector('.step-item:nth-child(5)').classList.add('active');
                    break;
            }
        }

        // æ›´æ¢ä¸Šä¼ æ–‡ä»¶
        function changeUploadedFile() {
            // é‡ç½®æ‰€æœ‰åŒºåŸŸ
            const uploadSection = document.getElementById('uploadSection');
            const uploadedDataSection = document.getElementById('uploadedDataSection');
            const predictionProgressSection = document.getElementById('predictionProgressSection');
            const predictionResultsSection = document.getElementById('predictionResultsSection');
            
            uploadSection.style.display = 'block';
            uploadedDataSection.style.display = 'none';
            predictionProgressSection.style.display = 'none';
            predictionResultsSection.style.display = 'none';
            
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            const fileInput = document.getElementById('fileInput');
            fileInput.value = '';
            
            // é‡ç½®æ•°æ®
            window.selectedFile = null;
            window.fileData = null;
            window.predictionResults = null;
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            updateStepIndicator(1);
        }

        // æ˜¾ç¤ºé¢„æµ‹ç»“æœ
        function displayPredictionResults(result) {
            const resultsPreview = document.getElementById('resultsPreview');
            const predictionSummary = document.getElementById('predictionSummary');
            
            // æ›´æ–°ç»“æœè¡¨æ ¼
            let tableHTML = `
                <h4 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1rem; font-weight: 600;">
                    é¢„æµ‹ç»“æœ
                </h4>
                <div class="results-table">
                    <table>
                        <thead>
                            <tr>
                                <th>ç”µèŠ¯ç¼–å·</th>
                                <th>é¢„æµ‹å¾ªç¯å¯¿å‘½</th>
                                <th>è¯´æ˜</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // å¯¹barcodeè¿›è¡Œå»é‡ï¼Œæ¯ä¸ªbarcodeåªæ˜¾ç¤ºä¸€æ¬¡
            const uniqueResults = [];
            const seenBarcodes = new Set();
            
            result.results.forEach(item => {
                if (!seenBarcodes.has(item.barcode)) {
                    seenBarcodes.add(item.barcode);
                    uniqueResults.push(item);
                }
            });
            
            // æ˜¾ç¤ºå‰10ä¸ªå»é‡åçš„ç»“æœ
            const displayResults = uniqueResults.slice(0, 10);
            
            displayResults.forEach(item => {
                tableHTML += `
                    <tr>
                        <td>${item.barcode || 'N/A'}</td>
                        <td><strong>${item.cycleLife || 'N/A'}</strong></td>
                        <td style="color: #475569;">${item.explanation || 'N/A'}</td>
                    </tr>
                `;
            });
            
            if (uniqueResults.length > 10) {
                tableHTML += `
                    <tr>
                        <td colspan="3" style="text-align: center; color: #6b7280; font-style: italic;">
                            è¿˜æœ‰ ${uniqueResults.length - 10} ä¸ªç”µèŠ¯æœªæ˜¾ç¤º...
                        </td>
                    </tr>
                `;
            }
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            resultsPreview.innerHTML = tableHTML;
            resultsPreview.style.display = 'block';
            
            // æ›´æ–°é¢„æµ‹æ‘˜è¦
            if (result.summary) {
                // è®¡ç®—å»é‡åçš„ç”µèŠ¯æ•°é‡
                const uniqueBarcodes = new Set(result.results.map(item => item.barcode));
                const uniqueSampleCount = uniqueBarcodes.size;
                
                document.getElementById('totalSamples').textContent = `${uniqueSampleCount} ä¸ª`;
                document.getElementById('avgCycleLife').textContent = `${result.summary.averageCycleLife} æ¬¡`;
                document.getElementById('predictionTime').textContent = new Date(result.summary.predictionTime).toLocaleString('zh-CN');
                predictionSummary.style.display = 'block';
            }
            
            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            resultsPreview.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // æ ·ä¾‹æ•°æ®å®šä¹‰
        const sampleDataSets = {
            battery: {
                title: 'ç”µæ± å¾ªç¯æ•°æ®',
                description: 'åŒ…å«15ä¸ªç”µæ± æ ·æœ¬çš„å¾ªç¯æµ‹è¯•æ•°æ®',
                data: [
                    { Barcode: 'BAT001', Cycle: 5, Capacity: 0.985, Voltage: 3.65, Temperature: 25.2, Charge_Time: 120, Discharge_Time: 95, Internal_Resistance: 0.045 },
                    { Barcode: 'BAT002', Cycle: 8, Capacity: 0.972, Voltage: 3.62, Temperature: 26.1, Charge_Time: 118, Discharge_Time: 92, Internal_Resistance: 0.048 },
                    { Barcode: 'BAT003', Cycle: 12, Capacity: 0.958, Voltage: 3.58, Temperature: 24.8, Charge_Time: 122, Discharge_Time: 98, Internal_Resistance: 0.052 },
                    { Barcode: 'BAT004', Cycle: 15, Capacity: 0.945, Voltage: 3.55, Temperature: 25.5, Charge_Time: 125, Discharge_Time: 100, Internal_Resistance: 0.055 },
                    { Barcode: 'BAT005', Cycle: 20, Capacity: 0.928, Voltage: 3.52, Temperature: 26.3, Charge_Time: 128, Discharge_Time: 103, Internal_Resistance: 0.058 },
                    { Barcode: 'BAT006', Cycle: 25, Capacity: 0.912, Voltage: 3.48, Temperature: 25.9, Charge_Time: 130, Discharge_Time: 105, Internal_Resistance: 0.062 },
                    { Barcode: 'BAT007', Cycle: 30, Capacity: 0.895, Voltage: 3.45, Temperature: 24.7, Charge_Time: 132, Discharge_Time: 107, Internal_Resistance: 0.065 },
                    { Barcode: 'BAT008', Cycle: 35, Capacity: 0.878, Voltage: 3.42, Temperature: 25.8, Charge_Time: 135, Discharge_Time: 110, Internal_Resistance: 0.068 },
                    { Barcode: 'BAT009', Cycle: 40, Capacity: 0.862, Voltage: 3.38, Temperature: 26.2, Charge_Time: 138, Discharge_Time: 112, Internal_Resistance: 0.072 },
                    { Barcode: 'BAT010', Cycle: 45, Capacity: 0.845, Voltage: 3.35, Temperature: 25.4, Charge_Time: 140, Discharge_Time: 115, Internal_Resistance: 0.075 },
                    { Barcode: 'BAT011', Cycle: 50, Capacity: 0.828, Voltage: 3.32, Temperature: 26.0, Charge_Time: 142, Discharge_Time: 117, Internal_Resistance: 0.078 },
                    { Barcode: 'BAT012', Cycle: 55, Capacity: 0.812, Voltage: 3.28, Temperature: 25.6, Charge_Time: 145, Discharge_Time: 120, Internal_Resistance: 0.082 },
                    { Barcode: 'BAT013', Cycle: 60, Capacity: 0.795, Voltage: 3.25, Temperature: 26.4, Charge_Time: 148, Discharge_Time: 122, Internal_Resistance: 0.085 },
                    { Barcode: 'BAT014', Cycle: 65, Capacity: 0.778, Voltage: 3.22, Temperature: 25.1, Charge_Time: 150, Discharge_Time: 125, Internal_Resistance: 0.088 },
                    { Barcode: 'BAT015', Cycle: 70, Capacity: 0.762, Voltage: 3.18, Temperature: 25.9, Charge_Time: 152, Discharge_Time: 127, Internal_Resistance: 0.092 }
                ]
            },
            performance: {
                title: 'æ€§èƒ½è¡¨å¾æ•°æ®',
                description: 'ç”µæ± å®¹é‡ã€ç”µå‹ã€æ¸©åº¦ç­‰æ€§èƒ½å‚æ•°',
                data: [
                    { Sample: 'P001', Capacity_mAh: 2500, Voltage_V: 3.7, Temperature_C: 25.0, Cycle_Count: 100, Charge_Rate_C: 1.0, Discharge_Rate_C: 1.0, Internal_Resistance_mOhm: 45 },
                    { Sample: 'P002', Capacity_mAh: 2480, Voltage_V: 3.68, Temperature_C: 25.2, Cycle_Count: 150, Charge_Rate_C: 1.0, Discharge_Rate_C: 1.0, Internal_Resistance_mOhm: 48 },
                    { Sample: 'P003', Capacity_mAh: 2450, Voltage_V: 3.65, Temperature_C: 24.8, Cycle_Count: 200, Charge_Rate_C: 1.0, Discharge_Rate_C: 1.0, Internal_Resistance_mOhm: 52 },
                    { Sample: 'P004', Capacity_mAh: 2420, Voltage_V: 3.62, Temperature_C: 25.5, Cycle_Count: 250, Charge_Rate_C: 1.0, Discharge_Rate_C: 1.0, Internal_Resistance_mOhm: 55 },
                    { Sample: 'P005', Capacity_mAh: 2380, Voltage_V: 3.58, Temperature_C: 26.1, Cycle_Count: 300, Charge_Rate_C: 1.0, Discharge_Rate_C: 1.0, Internal_Resistance_mOhm: 58 },
                    { Sample: 'P006', Capacity_mAh: 2350, Voltage_V: 3.55, Temperature_C: 25.8, Cycle_Count: 350, Charge_Rate_C: 1.0, Discharge_Rate_C: 1.0, Internal_Resistance_mOhm: 62 },
                    { Sample: 'P007', Capacity_mAh: 2320, Voltage_V: 3.52, Temperature_C: 24.9, Cycle_Count: 400, Charge_Rate_C: 1.0, Discharge_Rate_C: 1.0, Internal_Resistance_mOhm: 65 },
                    { Sample: 'P008', Capacity_mAh: 2280, Voltage_V: 3.48, Temperature_C: 25.3, Cycle_Count: 450, Charge_Rate_C: 1.0, Discharge_Rate_C: 1.0, Internal_Resistance_mOhm: 68 }
                ]
            }
        };

        let currentSampleDataType = null;

        // é¢„è§ˆæ ·ä¾‹æ•°æ®
        function previewSampleData(type) {
            const dataSet = sampleDataSets[type];
            if (!dataSet) {
                alert('æœªæ‰¾åˆ°æŒ‡å®šçš„æ ·ä¾‹æ•°æ®');
                return;
            }

            currentSampleDataType = type;
            const modal = document.getElementById('sampleDataModal');
            const modalTitle = document.getElementById('modalTitle');
            const dataInfo = document.getElementById('dataInfo');
            const dataTable = document.getElementById('dataTable');

            // è®¾ç½®æ ‡é¢˜
            modalTitle.textContent = dataSet.title;

            // ç”Ÿæˆæ•°æ®ä¿¡æ¯
            const uniqueSamples = new Set(dataSet.data.map(row => row.Barcode || row.Sample)).size;
            const avgCapacity = dataSet.data.reduce((sum, row) => sum + (row.Capacity || row.Capacity_mAh), 0) / dataSet.data.length;
            const avgVoltage = dataSet.data.reduce((sum, row) => sum + (row.Voltage || row.Voltage_V), 0) / dataSet.data.length;

            dataInfo.innerHTML = `
                <div class="info-item">
                    <span class="info-label">æ ·æœ¬æ•°é‡</span>
                    <span class="info-value">${uniqueSamples}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æ•°æ®è¡Œæ•°</span>
                    <span class="info-value">${dataSet.data.length}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å¹³å‡å®¹é‡</span>
                    <span class="info-value">${avgCapacity.toFixed(3)}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å¹³å‡ç”µå‹</span>
                    <span class="info-value">${avgVoltage.toFixed(2)}V</span>
                </div>
            `;

            // ç”Ÿæˆæ•°æ®è¡¨æ ¼
            const headers = Object.keys(dataSet.data[0]);
            const headerRow = headers.map(header => `<th>${header}</th>`).join('');
            const dataRows = dataSet.data.map(row => 
                `<tr>${headers.map(header => `<td>${row[header]}</td>`).join('')}</tr>`
            ).join('');

            dataTable.innerHTML = `
                <thead>
                    <tr>${headerRow}</tr>
                </thead>
                <tbody>
                    ${dataRows}
                </tbody>
            `;

            // æ˜¾ç¤ºå¼¹çª—
            modal.classList.add('show');
        }

        // ä½¿ç”¨æ ·ä¾‹æ•°æ®
        function useSampleData(type) {
            const dataSet = sampleDataSets[type];
            if (!dataSet) {
                alert('æœªæ‰¾åˆ°æŒ‡å®šçš„æ ·ä¾‹æ•°æ®');
                return;
            }

            // å°†æ ·ä¾‹æ•°æ®è½¬æ¢ä¸ºCSVæ ¼å¼
            const headers = Object.keys(dataSet.data[0]);
            const csvContent = [
                headers.join(','),
                ...dataSet.data.map(row => headers.map(header => row[header]).join(','))
            ].join('\n');

            // åˆ›å»ºæ–‡ä»¶å¯¹è±¡
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const file = new File([blob], `${dataSet.title}.csv`, { type: 'text/csv' });

            // æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ 
            handleFileSelect(file);

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            alert(`å·²æˆåŠŸåŠ è½½${dataSet.title}ï¼`);
        }

        // ä»å¼¹çª—ä½¿ç”¨æ ·ä¾‹æ•°æ®
        function useSampleDataFromModal() {
            if (currentSampleDataType) {
                useSampleData(currentSampleDataType);
                closeSampleDataModal();
            }
        }

        // å…³é—­æ ·ä¾‹æ•°æ®å¼¹çª—
        function closeSampleDataModal() {
            const modal = document.getElementById('sampleDataModal');
            modal.classList.remove('show');
            currentSampleDataType = null;
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('sampleDataModal');
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeSampleDataModal();
                }
            });
        });

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded event fired');
            try {
                loadHistoryFromStorage();
                setupFileUpload();
                
                if (earlyLifeHistory.length === 0) {
                    addVirtualHistory();
                }
                
                // ç»‘å®šæ–‡ä»¶ä¸Šä¼ äº‹ä»¶
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.addEventListener('change', handleFileSelect);
                }
                
                // åˆå§‹åŒ–æ­¥éª¤æŒ‡ç¤ºå™¨
                updateStepIndicator(1);
                
                // è¿è¡Œè°ƒè¯•æ£€æŸ¥
                setTimeout(() => {
                    console.log('\n=== è¿è¡Œè°ƒè¯•æ£€æŸ¥ ===');
                    runAllChecks();
                }, 1000);
                
                console.log('æ‰€æœ‰åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('åˆå§‹åŒ–é”™è¯¯:', error);
                alert('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        });

        // å¯¼å‡ºåˆ°å…¨å±€ä½œç”¨åŸŸ
        window.testClick = testClick;
        window.runAllChecks = runAllChecks;
        window.downloadSampleData = downloadSampleData;
        window.previewUploadedData = previewUploadedData;
        window.closeDataPreview = closeDataPreview;
        window.changeUploadedFile = changeUploadedFile;
        window.closeHistoryResultModal = closeHistoryResultModal;
        window.downloadOriginalData = downloadOriginalData;
        window.selectModel = selectModel;
        window.switchToStep = switchToStep;
        window.runPrediction = runPrediction;
    </script>
</body>
</html> 